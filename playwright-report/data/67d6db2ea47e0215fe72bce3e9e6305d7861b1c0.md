# Test info

- Name: Data Safety - Backup & Restore >> should show an alert when restoring JSON with missing structure (e.g., no meta key)
- Location: C:\Users\E915908\Documents\Projects\soccer-app\tests\backup-restore.spec.ts:504:9

# Error details

```
Error: expect(locator).toBeVisible()

Locator: locator('button[title="controlBar.settings"]')
Expected: visible
Received: <element(s) not found>
Call log:
  - expect.toBeVisible with timeout 30000ms
  - waiting for locator('button[title="controlBar.settings"]')

    at C:\Users\E915908\Documents\Projects\soccer-app\tests\backup-restore.spec.ts:101:42
```

# Page snapshot

```yaml
- text: Loading...
```

# Test source

```ts
   1 | import { test, expect, Page } from '@playwright/test';
   2 | import { 
   3 |     SAVED_GAMES_KEY, 
   4 |     APP_SETTINGS_KEY, 
   5 |     SEASONS_LIST_KEY, 
   6 |     TOURNAMENTS_LIST_KEY, 
   7 |     MASTER_ROSTER_KEY, 
   8 |     LAST_HOME_TEAM_NAME_KEY 
   9 | } from '../src/config/constants';
   10 |
   11 | // Define expected structure for parsed data (can be refined based on actual types)
   12 | interface LocalStorageValues {
   13 |   [SAVED_GAMES_KEY]?: Record<string, object> | null;
   14 |   [APP_SETTINGS_KEY]?: { currentGameId: string | null } | null;
   15 |   [SEASONS_LIST_KEY]?: Array<object> | null;
   16 |   [TOURNAMENTS_LIST_KEY]?: Array<object> | null;
   17 |   [MASTER_ROSTER_KEY]?: Array<object> | null;
   18 |   [LAST_HOME_TEAM_NAME_KEY]?: string | null;
   19 |   [key: string]: unknown; // Use unknown instead of any for better type safety
   20 | }
   21 |
   22 | // Define structure for the backup file format
   23 | interface BackupFormat {
   24 |   meta: {
   25 |     schema: number;
   26 |     exportedAt: string;
   27 |   };
   28 |   localStorage: Partial<LocalStorageValues>; // Use partial as not all keys might be present
   29 | }
   30 |
   31 | // Helper function - Use the defined interface
   32 | async function getLocalStorageData(page: Page): Promise<LocalStorageValues> {
   33 |     return await page.evaluate(({ keys }: { keys: string[] }) => {
   34 |         const data: LocalStorageValues = {}; // Use defined interface
   35 |         keys.forEach((key: string) => {
   36 |             const item = localStorage.getItem(key);
   37 |             try {
   38 |                 data[key] = item ? JSON.parse(item) : null;
   39 |             } catch (parseError: unknown) { // Use unknown
   40 |                 console.warn(`Failed to parse localStorage item ${key}:`, parseError);
   41 |                 data[key] = item; 
   42 |             }
   43 |         });
   44 |         return data;
   45 |     }, { keys: [SAVED_GAMES_KEY, APP_SETTINGS_KEY, SEASONS_LIST_KEY, TOURNAMENTS_LIST_KEY, MASTER_ROSTER_KEY, LAST_HOME_TEAM_NAME_KEY] });
   46 | }
   47 |
   48 | test.describe('Data Safety - Backup & Restore', () => {
   49 |     test.describe.configure({ mode: 'serial' }); // Run tests in this file serially
   50 |
   51 |     test.beforeEach(async ({ page }) => {
   52 |         await page.goto('/');
   53 |         // Clear localStorage before each test
   54 |         await page.evaluate(() => localStorage.clear());
   55 |
   56 |         // --- Setup Initial Data for tests in this suite ---
   57 |         const initialDataForSuite = {
   58 |              [SAVED_GAMES_KEY]: { 'game1': { id: 'game1', teamName: 'Test Team', opponentName: 'Test Opponent', homeScore: 1, awayScore: 0 }},
   59 |              [APP_SETTINGS_KEY]: { currentGameId: 'game1' }, // This should prevent setup modal
   60 |              [SEASONS_LIST_KEY]: [{ id: 's1', name: 'Test Season' }],
   61 |              [TOURNAMENTS_LIST_KEY]: [],
   62 |              [MASTER_ROSTER_KEY]: [{ id: 'p1', name: 'Test Player' }],
   63 |              [LAST_HOME_TEAM_NAME_KEY]: 'Test Team'
   64 |         };
   65 |         await page.evaluate((data: Partial<LocalStorageValues>) => {
   66 |              for (const key in data) {
   67 |                  if (data[key] !== null && data[key] !== undefined) {
   68 |                      localStorage.setItem(key, JSON.stringify(data[key]));
   69 |                  } else {
   70 |                      localStorage.removeItem(key);
   71 |                  }
   72 |              }
   73 |          }, initialDataForSuite);
   74 |         console.log('Initial localStorage data set for backup/restore suite.');
   75 |
   76 |         // --- Reload page to load initial data --- 
   77 |         await page.reload();
   78 |         console.log('Page reloaded after setting localStorage for backup/restore suite.');
   79 |         
   80 |         // Handle potential unexpected setup modal (copied from data-persistence.spec.ts)
   81 |         const setupModalHeadingLocator = page.getByRole('heading', { name: 'Uuden Pelin Asetukset' });
   82 |         const newGameSetupModal = page.getByTestId('new-game-setup-modal'); // Ensure this test ID exists or adjust
   83 |         try {
   84 |           await expect(setupModalHeadingLocator).toBeVisible({ timeout: 10000 }); // Check if modal appears
   85 |           console.log('Unexpected setup modal found in backup/restore suite, attempting to close it...');
   86 |           const homeTeamLabelFinnish = 'Oman joukkueen nimi: *';
   87 |           const opponentLabelFinnish = 'Vastustajan Nimi: *';
   88 |           await page.getByLabel(homeTeamLabelFinnish).fill('Workaround Home BR'); 
   89 |           await page.getByLabel(opponentLabelFinnish).fill('Workaround Away BR'); 
   90 |           await page.getByRole('button', { name: 'Aloita Peli' }).click();
   91 |           await expect(newGameSetupModal).not.toBeVisible({ timeout: 5000 }); 
   92 |           console.log('Closed unexpected setup modal in backup/restore suite.');
   93 |         } catch {
   94 |           console.log('Setup modal did not appear in backup/restore suite (expected or handled).');
   95 |         }
   96 |         await page.waitForTimeout(250); // Brief pause for UI to settle
   97 |
   98 |         // --- Ensure the main UI is ready before tests start ---
   99 |         await expect(page.locator('body')).toBeVisible(); // Basic check for body
  100 |         const mainSettingsButton = page.locator('button[title="controlBar.settings"]');
> 101 |         await expect(mainSettingsButton).toBeVisible({ timeout: 30000 }); 
      |                                          ^ Error: expect(locator).toBeVisible()
  102 |         console.log('Main UI confirmed ready after reload in backup/restore suite.');
  103 |     });
  104 |
  105 |     test('should generate a backup file containing all relevant localStorage data', async ({ page }) => {
  106 |         // Test should now start with the main UI visible after beforeEach completes
  107 |         console.log('Generate backup test started.');
  108 |         
  109 |         const settingsButtonLocator = page.locator('button[title="controlBar.settings"]');
  110 |         
  111 |         // Wait for the button to be visible (should be faster now)
  112 |         await expect(settingsButtonLocator).toBeVisible({ timeout: 10000 }); 
  113 |         console.log('Settings button is visible.');
  114 |         
  115 |         // Click the button
  116 |         await settingsButtonLocator.click();
  117 |         console.log('Clicked settings button.');
  118 |
  119 |         await page.waitForTimeout(500); // Wait for menu
  120 |         console.log('Waited for menu.');
  121 |         await page.getByText('Lataa Peli').click(); 
  122 |         console.log('Clicked Load Game menu item.');
  123 |
  124 |         const loadGameModalHeading = page.getByRole('heading', { name: /Lataa Peli/i });
  125 |         await expect(loadGameModalHeading).toBeVisible();
  126 |         console.log('Load Game modal is visible.');
  127 |         
  128 |         const actualLocalStorageData = await getLocalStorageData(page);
  129 |
  130 |         // --- 3. Capture Download --- 
  131 |         const downloadPromise = page.waitForEvent('download');
  132 |         await page.getByRole('button', { name: /Varmuuskopioi Kaikki Tiedot/i }).click();
  133 |         const download = await downloadPromise;
  134 |
  135 |         // Read the downloaded file content
  136 |         const readStream = await download.createReadStream();
  137 |         const chunks = [];
  138 |         for await (const chunk of readStream) {
  139 |             chunks.push(chunk);
  140 |         }
  141 |         const backupFileContentString = Buffer.concat(chunks).toString('utf-8');
  142 |
  143 |         // Ensure we captured valid backup data string
  144 |         expect(backupFileContentString, 'Should have captured backup content string via download').not.toBe('');
  145 |
  146 |         // Use defined BackupFormat type
  147 |         let downloadedBackupData: BackupFormat;
  148 |         try {
  149 |             downloadedBackupData = JSON.parse(backupFileContentString);
  150 |         } catch (parseError: unknown) { // Use unknown
  151 |             // Check if it's an error instance before accessing message
  152 |             const errorMessage = parseError instanceof Error ? parseError.message : String(parseError);
  153 |             throw new Error(`Failed to parse downloaded backup JSON: ${errorMessage}`);
  154 |         }
  155 |
  156 |         console.log('Successfully captured and parsed backup data via download event.');
  157 |
  158 |         // --- 4. Assertions on Downloaded Data --- 
  159 |         // Basic structure checks
  160 |         expect(downloadedBackupData.meta, 'Downloaded backup should have meta field').toBeDefined();
  161 |         expect(downloadedBackupData.meta.schema, 'Downloaded meta schema should be 1').toBe(1);
  162 |         expect(downloadedBackupData.localStorage, 'Downloaded backup should have localStorage field').toBeDefined();
  163 |
  164 |         // Verify the content matches the actual localStorage data fetched earlier
  165 |         // Using the actual keys expected in the backup file structure
  166 |         expect(downloadedBackupData.localStorage.savedSoccerGames, 'Saved games data mismatch in download').toEqual(actualLocalStorageData[SAVED_GAMES_KEY]);
  167 |         expect(downloadedBackupData.localStorage.soccerAppSettings, 'App settings data mismatch in download').toEqual(actualLocalStorageData[APP_SETTINGS_KEY]);
  168 |         expect(downloadedBackupData.localStorage.soccerSeasons, 'Seasons data mismatch in download').toEqual(actualLocalStorageData[SEASONS_LIST_KEY]);
  169 |         expect(downloadedBackupData.localStorage.soccerTournaments, 'Tournaments data mismatch in download').toEqual(actualLocalStorageData[TOURNAMENTS_LIST_KEY]);
  170 |         expect(downloadedBackupData.localStorage.soccerMasterRoster, 'Master roster data mismatch in download').toEqual(actualLocalStorageData[MASTER_ROSTER_KEY]);
  171 |
  172 |         console.log('Downloaded backup data verification successful.');
  173 |
  174 |         // --- Explicitly close Load Game Modal and wait --- 
  175 |         // Find the modal using its heading
  176 |         const loadGameModal = page.locator('div.fixed.inset-0 > div.bg-slate-800')
  177 |                                   .filter({ has: page.getByRole('heading', { name: /Lataa Peli/i }) });
  178 |         
  179 |         // Find the close button within the modal using getByRole
  180 |         const closeButton = loadGameModal.getByRole('button', { name: /Sulje/i }); // Use Finnish text
  181 |         
  182 |         // Wait longer for the button to be visible after download
  183 |         await expect(closeButton).toBeVisible({timeout: 7000}); 
  184 |         await closeButton.click();
  185 |         console.log('Clicked Close button on Load Game modal.');
  186 |         
  187 |         // Wait for the modal heading to NOT be visible as confirmation
  188 |         await expect(page.getByRole('heading', { name: /Lataa Peli/i })).not.toBeVisible({ timeout: 5000 }); 
  189 |         console.log('Load Game modal is closed.');
  190 |         
  191 |         // Now it should be safe to interact with the control bar again if needed
  192 |         // (e.g., if we needed to click settings button again)
  193 |     });
  194 |
  195 |     // --- Add Backup Restore Success Test --- 
  196 |     test('should successfully restore data from a valid backup file', async ({ page }) => {
  197 |         // Test should start with the main UI visible after beforeEach completes
  198 |         console.log('Restore test started.');
  199 |
  200 |         // --- 1. Initial setup - Create state A ---
  201 |         // No page.goto or initial clear needed here, handled by beforeEach
```